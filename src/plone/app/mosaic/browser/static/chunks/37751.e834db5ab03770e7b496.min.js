"use strict";(self.webpackChunkplone_mosaic=self.webpackChunkplone_mosaic||[]).push([[37751],{37751:function(e,t,o){o.r(t);var i=o(2511),a=o.n(i),n=o(23505),s=o(56917),c=o(31875),r=o(59994);const l=n.A.getLogger("pat-mosaic/actions");t.default=class{constructor(e){this.mosaic=e,this.actions=[],this.shortcuts=[]}registerAction(e,t){t={exec:function(){},shortcut:{ctrl:!1,alt:!1,shift:!1,key:""},visible:function(){return!0},...t},this.actions[e]=t,""!==t.shortcut.key&&(t.shortcut.charCode=t.shortcut.key.toUpperCase().charCodeAt(0),t.shortcut.action=e,this.shortcuts.push(t.shortcut))}execAction(e,t){if(e in this.actions)return l.debug(`Executing action "${e}" ↓`,this.actions[e]),l.debug("from source ↓",t),this.actions[e].exec(t);l.error(`Action ${e} not in "${this.actions}"`)}getPrefixedClassName(e){return e.indexOf("-")>-1?"mosaic-"+e:"mosaic"+e.charAt(0).toUpperCase()+e.slice(1)}async initActions(){var e=this,t=e.mosaic;e.registerAction("tile-toggle-class",{exec:function(){var o;arguments.length>0&&arguments[0].value&&(o=e.getPrefixedClassName(arguments[0].value),a()(".mosaic-selected-tile",t.document).toggleClass(o))}}),e.registerAction("tile-remove-format",{exec:function(){var o,i,n,s,c;for(o=0;o<t.options.formats.length;o++)for(n=t.options.formats[o],i=0;i<n.actions.length;i++)"tile"===(s=n.actions[i]).category&&(c=e.getPrefixedClassName(s.name),a()(".mosaic-selected-tile",t.document).removeClass(c))}}),e.registerAction("row-toggle-class",{exec:function(){var o;arguments.length>0&&arguments[0].value&&(o=e.getPrefixedClassName(arguments[0].value),a()(".mosaic-selected-tile",t.document).parents(".mosaic-grid-row").first().toggleClass(o))}}),e.registerAction("row-remove-format",{exec:function(){var o,i,n,s,c;for(o=0;o<t.options.formats.length;o++)for(n=t.options.formats[o],i=0;i<n.actions.length;i++)"row"===(s=n.actions[i]).category&&(c=e.getPrefixedClassName(s.name),a()(".mosaic-selected-tile",t.document).parents(".mosaic-grid-row").first().removeClass(c).removeClass(s.name))}}),e.registerAction("tile-align-block",{exec:function(){a()(".mosaic-selected-tile",t.document).removeClass("mosaic-tile-align-right").removeClass("mosaic-tile-align-left")},shortcut:{ctrl:!0,alt:!1,shift:!0,key:"b"}}),e.registerAction("tile-align-left",{exec:function(){a()(".mosaic-selected-tile",t.document).removeClass("mosaic-tile-align-right").addClass("mosaic-tile-align-left")},shortcut:{ctrl:!0,alt:!1,shift:!0,key:"l"}}),e.registerAction("tile-align-right",{exec:function(){a()(".mosaic-selected-tile",t.document).removeClass("mosaic-tile-align-left").addClass("mosaic-tile-align-right")},shortcut:{ctrl:!0,alt:!1,shift:!0,key:"r"}}),e.registerAction("save",{exec:function(o){if(t.saving_tile)return l.debug("Wait for saving tiles"),void window.setTimeout((()=>{e.execAction("save",o)}),500);t.saving=!0,e.blurSelectedTile(),t.toolbar.SelectedTileChange(),t.layoutManager.saveLayoutToForm(),t.save(),t.saving=!1},shortcut:{ctrl:!0,alt:!1,shift:!1,key:"s"}}),e.registerAction("cancel",{exec:function(){a()("#form-buttons-cancel").trigger("click")}}),e.registerAction("preview",{exec:function(){a()("#form-widgets-ILayoutAware-customContentLayout, [name='form.widgets.ILayoutAware.customContentLayout']").trigger("focus").trigger("focusout"),setTimeout((function(){window.open(t.options.context_url+"/@@layout_preview","_blank")}),1e3)}}),e.registerAction("html",{exec:function(){var e,o,i;0===(e=a()(".mosaic-selected-tile",t.document).children(".mosaic-tile-content")).find(".mosaic-rich-text-textarea").length&&(o=e.html(),i=e.height(),e.empty(),e.prepend(a()(t.document.createElement("textarea")).addClass("mosaic-rich-text-textarea").html(o.trim()).height(i)))}}),e.registerAction("properties",{exec:function(){t.overlay.open("all")}}),e.registerAction("layout",{exec:function(){a()(".mosaic-button-group-layout").toggleClass("active")},visible:function(){return!0}}),e.registerAction("customizelayout",{exec:function(){t.setSelectedContentLayout(""),a()(".mosaic-toolbar-secondary-functions").removeClass("d-none"),a()(".mosaic-button-customizelayout").hide(),a()(".mosaic-button-savelayout").show(),a()(".mosaic-panel .mosaic-tile",t.document).each((function(){var e=a()(this).data("mosaic-tile");e.makeMovable(),e.$el.mosaicAddDrag()})),a()(".mosaic-button-group-layout").removeClass("active")},visible:function(){return t.hasContentLayout&&t.options.canChangeLayout}}),e.registerAction("changelayout",{exec:function(){var e=t.hasContentLayout;e||(e=confirm("Changing your layout will destroy all existing custom layout settings you have in place. Are you sure you want to continue?")),e&&t.selectLayout(),a()(".mosaic-button-group-layout").removeClass("active")},visible:function(){return t.options.available_layouts.length>0}}),e.registerAction("savelayout",{exec:function(){t.saveLayout(),a()(".mosaic-button-group-layout").removeClass("active")},visible:function(){return!0}}),e.registerAction("add-tile",{exec:function(){new c.A(".mosaic-toolbar",{modalSizeClass:"modal-lg",ajaxUrl:t.options.context_url+"/@@add-tile?form.button.Create=Create",backdropOptions:{closeOnClick:!1}}).show()}}),e.registerAction("format",{exec:function(t){var o=a()(t).val(),i=a()(t).find(`[value="${o}"]`).data("action");e.execAction(i,t),a()(t).select2("val","none")}}),e.registerAction("insert",{exec:async function(o){var i,n;if("none"===a()(o).val())return!1;n=a()(o).val(),e.blurSelectedTile(),t.toolbar.SelectedTileChange();for(const e of t.options.tiles)for(const t of e.tiles)t.name===n&&(i=t);if("textapp"===i.tile_type){var u=s.A.generate_uid(),m=t.options.context_url+"/@@"+n+"/"+u,d="<html><body>"+t.layoutManager.getDefaultValue(i)+"</body></html>";t.layoutManager.addAppTileHTML(n,d,m)}else if("app"===i.tile_type){r.A.loading.show();const o=function(o){let i=!0;const s=new c.A(e.mosaic.panels[0],{html:o,modalSizeClass:"modal-lg",position:"center top",buttons:'.formControls > button[type="submit"], .actionButtons > button[type="submit"]',backdropOptions:{closeOnClick:!1}});s.on("after-render",(()=>{var e=s.$modalContent;i&&(a()(".field.error",e).removeClass("error"),a()(".fieldErrorBox,.portalMessage,.alert,.invalid-feedback",e).remove()),a()('button[name*="cancel"]',e).off("click").on("click",(function(){s.hide()})),l.debug("after-render")})),s.on("formActionSuccess",((e,o,a,c)=>{l.debug("TileAddForm ActionSuccess");var r=c.getResponseHeader("X-Tile-Url");r&&i&&(t.layoutManager.addAppTileHTML(n,o,r),i=!1),s.hide()})),s.show()};fetch(`${t.options.context_url}/@@add-tile?tiletype=${n}&form.button.Create=Create`,{method:"GET"}).then((e=>{if(e.ok)return e.text();alert(`Could not create tile ${n}: ${e.statusText}`)})).then((e=>{r.A.loading.hide();const i=a()(e);let s=i.find("#add_tile").attr("action");const c=i.find('[name="_authenticator"]').val();a()("form .required",i).filter((function(){var e=a()(this).parents(".field").first().find("input, select, textarea").not('[type="hidden"]').last().val();return null===e||0===e.length})).length>0?o(e):s&&a()("form",i).ajaxSubmit({type:"POST",url:s,data:{"buttons.save":"Save",_authenticator:c},success:function(e,i,a){var s=a.getResponseHeader("X-Tile-Url");s?t.layoutManager.addAppTileHTML(n,e,s):o(e)}})}))}else await t.layoutManager.addTile(n,t.layoutManager.getDefaultValue(i));return a()(o).select2("val","none"),!0}}),a()(document).on("keypress",(function(e){var o="";return a()(t.actionManager.shortcuts).each((function(){e.ctrlKey!==this.ctrl&&(-1===navigator.userAgent.toLowerCase().indexOf("macintosh")||e.metaKey!==this.ctrl)||e.altKey!==this.alt&&void 0!==e.altKey||e.shiftKey!==this.shift||e.key.toUpperCase().charCodeAt(0)!==this.charCode||(o=this.action)})),""===o||(t.actionManager.actions[o].exec(),!1)}))}blurSelectedTile(){const e=this.mosaic.document.querySelectorAll(".mosaic-selected-tile");e.length&&(l.debug("blur selected tile(s) ↓",e),e.forEach((async e=>await e["mosaic-tile"].blur())))}mosaicExecAction(){return this.each((function(){""!==a()(this).data("action")&&a().mosaic.actionManager.actions[a()(this).data("action")].exec(this)}))}}}}]);
//# sourceMappingURL=37751.e834db5ab03770e7b496.min.js.map